<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ecobay.user.mapper.ProductMapper">

	<select id="select" resultType="productVO">
		SELECT  *
		   FROM product
		  WHERE USE_YN = TRUE
		    AND product_cd = #{product_cd}
	</select>

	<select id="selectDetail" resultType="productVO">
		SELECT    prod.PRODUCT_CD, prod.PRODUCT_NM, prod.MEMBER_ID, prod.STATE_CD, prod.STATE_NM, prod.VIEWCNT
				, IFNULL(prod.CONTENT, '') as CONTENT
				, (SELECT COUNT(bid.PRODUCT_CD) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD) as BID_CNT
				, IFNULL((SELECT MAX(bid.MONEY_BID) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD), 0) as BID_MAX_MONEY
                , IFNULL(auct.AUCTDATE_UNIT, 0) as AUCTDATE_UNIT
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_START, '%Y-%m-%d %H:%s'), '') as ACUTDATE_START_STR
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_END, '%Y-%m-%d %H:%s'), '') as ACUTDATE_END_STR
				, IFNULL(auct.MONEY_FIRST, 0) as MONEY_FIRST
                , IFNULL(auct.MONEY_UNIT, 0) as MONEY_UNIT
                , auct.BAYNOW_YN
                , IFNULL(auct.BAYNOW_MONEY, 0) as BAYNOW_MONEY
                , IFNULL((SELECT deli.DELI_DIV_CD FROM deliveryinfo deli WHERE deli.PRODUCT_CD = prod.PRODUCT_CD), '') as DELI_DIV_CD
                , IFNULL((SELECT deli.DELI_DIV_NM FROM deliveryinfo deli WHERE deli.PRODUCT_CD = prod.PRODUCT_CD), '') as DELI_DIV_NM
		   FROM product prod LEFT JOIN  auctioninfo auct
             ON prod.PRODUCT_CD = auct.PRODUCT_CD
		  WHERE prod.USE_YN = TRUE
		    AND prod.product_cd = #{product_cd}
	</select>
	
	<select id="selectDetailProd" resultType="productVO">
		SELECT    prod.PRODUCT_CD, prod.PRODUCT_NM, prod.MEMBER_ID
                , prod.STATE_CD, prod.STATE_NM, prod.VIEWCNT
                , IFNULL(prod.CONTENT, '') as CONTENT
				, (SELECT COUNT(bid.PRODUCT_CD) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD) as BID_CNT
				, IFNULL((SELECT MAX(bid.MONEY_BID) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD), 0) as BID_MAX_MONEY
		   FROM product prod
		  WHERE prod.USE_YN = TRUE
		    AND prod.product_cd = #{product_cd}
	</select>
	
	<select id="selectDetailAuct" resultType="AuctionInfoVO">
		SELECT    auct.PRODUCT_CD
                , IFNULL(auct.AUCTDATE_UNIT, 0) as AUCTDATE_UNIT
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_START, '%Y-%m-%d %H:%s'), '') as ACUTDATE_START_STR
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_END, '%Y-%m-%d %H:%s'), '') as ACUTDATE_END_STR
				, IFNULL(auct.MONEY_FIRST, 0) as MONEY_FIRST
                , IFNULL(auct.MONEY_UNIT, 0) as MONEY_UNIT
                , auct.BAYNOW_YN
                , IFNULL(auct.BAYNOW_MONEY, 0) as BAYNOW_MONEY
		   FROM auctioninfo auct
		  WHERE auct.product_cd = #{product_cd}
	</select>
	
	<select id="selectDetailDeli" resultType="DeliveryInfoVO">
		SELECT    deli.PRODUCT_CD
                , IFNULL(deli.DELI_DIV_CD, '') as DELI_DIV_CD
                , IFNULL(deli.DELI_DIV_NM, '') as DELI_DIV_NM
		   FROM deliveryinfo deli
		  WHERE deli.product_cd = #{product_cd}
	</select>
	
	<select id="selectList" resultType="ProductVO">
		SELECT * FROM
		(
			 SELECT @rownum:=@rownum+1 as rn
			 		, prod.PRODUCT_CD, prod.PRODUCT_NM, prod.MEMBER_ID, prod.STATE_CD, prod.STATE_NM, prod.VIEWCNT
					, (SELECT COUNT(bid.PRODUCT_CD) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD) as BID_CNT
					, IFNULL((SELECT MAX(bid.MONEY_BID) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD), 0) as BID_MAX_MONEY
			        , IFNULL((SELECT prodimg.FILENAME_THUMB FROM productimg prodimg WHERE prodimg.PRODUCT_CD = prod.PRODUCT_CD ORDER BY prodimg.IMG_IDX ASC limit 1), '') as FILENAME_THUMB
			        , CASE 
						WHEN (prod.STATE_CD != '3') THEN IFNULL((SELECT DATE_FORMAT(auct.ACUTDATE_END, '%Y-%m-%d %H:%s') FROM auctioninfo auct WHERE auct.PRODUCT_CD = prod.PRODUCT_CD), '')
						ELSE '' END AS ACUTDATE_END_STR
					, IFNULL((SELECT auct.MONEY_FIRST FROM auctioninfo auct WHERE auct.PRODUCT_CD = prod.PRODUCT_CD), 0) as MONEY_FIRST
			   FROM product prod , (select @rownum:=0) tmp
			  WHERE prod.USE_YN = TRUE
			    AND prod.STATE_CD IN ('3', '5', '6', '7')
			    <if test="class_big_cd != null and class_big_cd != ''">
			    	AND prod.CLASS_BIG_CD = #{class_big_cd}
			    	<if test="class_mid_cd != null and class_mid_cd != 'XX'">
				    AND prod.CLASS_MID_CD = #{class_mid_cd}
				    </if>
			    </if>
				<if test="searchVal != null and searchVal != ''">
				AND prod.PRODUCT_NM like CONCAT('%',#{searchVal},'%')
				</if>
		) prodlist
		where prodlist.rn between #{start_num} and #{end_num}
	</select>
	
	<select id="selectListBest" resultType="ProductVO">
		SELECT bestprod.* 
  		FROM (SELECT @rownum:=@rownum+1 as rn, btprod.*
       		  FROM ( SELECT btp.* 
		              FROM( SELECT  prod.PRODUCT_CD, prod.PRODUCT_NM, prod.MEMBER_ID, prod.STATE_CD, prod.STATE_NM, prod.VIEWCNT
		                       , (SELECT COUNT(PRODUCT_CD) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD) as BID_CNT
		                       , IFNULL((SELECT MAX(MONEY_BID) FROM bidinfo bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD), 0) as BID_MAX_MONEY
		                       , IFNULL((SELECT prodimg.FILENAME_THUMB FROM productimg prodimg WHERE prodimg.PRODUCT_CD = prod.PRODUCT_CD ORDER BY prodimg.IMG_IDX ASC limit 1), '') as FILENAME_THUMB
		                       , '' as ACUTDATE_END_STR
		                       , IFNULL((SELECT auct.MONEY_FIRST FROM auctioninfo auct WHERE auct.PRODUCT_CD = prod.PRODUCT_CD), 0) as MONEY_FIRST
		                    FROM product prod
		                   WHERE prod.USE_YN = TRUE
		                     AND prod.STATE_CD = '3'
		             ) btp
              ORDER BY btp.BID_CNT DESC, btp.VIEWCNT DESC ) btprod , (select @rownum:=0) tmp
      	) bestprod
		WHERE bestprod.rn between #{start_num} and #{end_num}
	</select>
	
	<select id="selectImageList" resultType="ProductImageVO">
		SELECT *
		  FROM productimg
		 WHERE product_cd = #{product_cd}
	</select>
	
	<select id="selectBidList" resultType="BidInfoVO">
	  SELECT bid.* 
		FROM ( SELECT  @rownum:=@rownum+1 as rowcnt, bi.*
				FROM ( SELECT *
						 FROM bidinfo
				   	    WHERE product_cd = #{product_cd}
					 ORDER BY REGDATE DESC
					 ) bi, (select @rownum:=0) tmp 
			  ) bid
		WHERE bid.rowcnt between #{start_num} and #{end_num}
	</select>
	
	<select id="selectMaxMoneyBid" resultType="BidInfoVO">
		SELECT  IFNULL(max(MONEY_BID), 0) as MONEY_BID_MAX
			  , IFNULL(count(MONEY_BID), 0) as MEMBER_CNT
		  FROM bidinfo
		 WHERE product_cd = #{product_cd}
	</select>
	
	<select id="BidAllCnt" resultType="int">
		SELECT COUNT(PRODUCT_CD)
		  FROM bidinfo
	     WHERE PRODUCT_CD = #{product_cd} 
	</select>
	
	<select id="selectProdQnaList" resultType="ProductQnaVO">
		SELECT prodqna.*
		  FROM ( SELECT @rownum:=@rownum+1 as rowcnt, qna.*
				 FROM ( SELECT   q.QNA_IDX
							   , q.PRODUCT_CD
							   , IFNULL(q.MEMBER_ID, '') as MEMBER_ID
							   , IFNULL(q.TITLE, '') as TITLE
							   , IFNULL(q.CONTENT, '') as CONTENT
							   , IFNULL((SELECT qr.CONTENT FROM productqna qr WHERE qr.QNA_IDX = q.QNA_IDX AND qr.PRODUCT_CD = q.PRODUCT_CD AND qr.QNA_DIV = '2'), '') as QNA_REPLY
                               , IFNULL((SELECT qr.MEMBER_ID FROM productqna qr WHERE qr.QNA_IDX = q.QNA_IDX AND qr.PRODUCT_CD = q.PRODUCT_CD AND qr.QNA_DIV = '2'), '') as MEMBER_ID_BAY
							   , q.REGDATE
						  FROM productqna q
					     WHERE q.PRODUCT_CD = #{product_cd} 
					       AND q.QNA_DIV = '1'
				  	  ORDER BY q.QNA_IDX DESC
					) qna, (select @rownum:=0) tmp
				) prodqna
		 WHERE prodqna.rowcnt between #{start_num} and #{end_num}
	</select>
	
	<select id="ProdQnaAllCnt" resultType="int">
		SELECT COUNT(PRODUCT_CD)
		  FROM productqna
	     WHERE PRODUCT_CD = #{product_cd} 
	       AND QNA_DIV = '1'
	</select>

	<select id="bigclassList" resultType="ProductVO">
		SELECT CLASS_BIG_CD, CLASS_NM as CLASS_BIG_NM
		  FROM class
		 WHERE USE_YN = TRUE
		   AND CLASS_DIV = 'B'
	  ORDER BY CLASS_BIG_CD ASC
	</select>

	<select id="midclassList" resultType="ProductVO">
		SELECT CLASS_MID_CD, CLASS_NM as CLASS_MID_NM
		  FROM class
		 WHERE USE_YN = TRUE
		   AND CLASS_DIV = 'M'
		   AND CLASS_BIG_CD = #{class_big_cd}
	  ORDER BY CLASS_MID_CD ASC
	</select>

	<select id="maxCnt" parameterType="String" resultType="int">
		SELECT IFNULL(MAX(CAST(SUBSTRING(product_cd, 11, 4) as unsigned)), 0) +1 as maxCnt
		  FROM product
		 WHERE SUBSTRING(product_cd, 1, 10) = #{searchVal}
	</select>
	
	<select id="maxImgCnt" resultType="int">
		SELECT IFNULL(MAX(IMG_CD), 0) +1 as maxImgCnt
		  FROM productimg
	</select>
	
	<select id="maxQnaCnt" resultType="int">
		SELECT IFNULL(MAX(QNA_IDX), 0) +1 as maxQnaCnt
		  FROM productqna
	</select>
	
	<select id="selectProdviewcnt" resultType="int">
		SELECT IFNULL(VIEWCNT, 0) as VIEWCNT
		  FROM product
		 WHERE product_cd = #{product_cd}
	</select>
	
	<insert id="insert" parameterType="ProductVO">
		INSERT INTO product 
		     VALUES (#{product_cd}, #{product_nm}, #{member_id}, #{class_big_cd}, #{class_mid_cd}, #{content}, '1', '요청', now(), now(), null, TRUE, 0)
	</insert>
	
	<insert id="imageInsert" parameterType="ProductImageVO">
		INSERT INTO productimg 
		    VALUES (#{img_cd}, #{img_idx}, #{product_cd}, #{filename}, #{filename_org}, #{filename_thumb}, now())
	</insert>
	
	<insert id="auctInsert" parameterType="AuctionInfoVO">
		INSERT INTO auctioninfo 
		    VALUES (#{product_cd}, #{money_first}, 0, #{money_unit}, #{auctdate_unit}, #{acutdate_start}, #{acutdate_end}, #{baynow_yn}, #{baynow_money}, now(), #{bay_member_id}, #{payment_proc_cd})
	</insert>

	<insert id="deliInsert" parameterType="DeliveryInfoVO">
		INSERT INTO deliveryinfo
		    VALUES (#{product_cd}, #{deli_div_cd}, #{deli_div_nm}, now())
	</insert>
	
	<insert id="prodQnaInsert" parameterType="ProductQnaVO">
		INSERT INTO productqna
		    VALUES (#{qna_idx}, #{product_cd}, #{qna_div}, #{member_id}, #{title}, #{content}, now())
	</insert>
	
	<insert id="bidInsert" parameterType="BidInfoVO">
		INSERT INTO bidinfo
		    VALUES (#{product_cd}, #{member_id}, #{money_bid}, now())
	</insert>

	<delete id="prodQnaDelete" parameterType="int">
		DELETE FROM productqna
		 WHERE QNA_IDX = #{qna_idx}
	</delete>
	
	<update id="delete">
		UPDATE product
		   SET USE_YN = FALSE
		 WHERE product_cd = #{product_cd}
	</update>
	
	<update id="updateProdViewCnt">
		UPDATE product
		   SET VIEWCNT = #{viewcnt}
		 WHERE product_cd = #{product_cd}
	</update>
</mapper>
