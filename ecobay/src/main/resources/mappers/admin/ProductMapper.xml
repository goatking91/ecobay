<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ecobay.admin.mapper.ProductMapper">
	<select id="productList" resultType="ProductVO">
		SELECT pd.*
		  FROM( SELECT @rownum:=@rownum+1 AS rn, p.*
				  FROM ( SELECT pp.*
						   FROM PRODUCT pp
						  WHERE USE_YN = TRUE
						  <include refid="search" />
						) p, (SELECT @rownum:=0) tmp
			   ) pd
		   LIMIT #{startIndex},#{cntPerPage}
	</select>
	
	<select id="productCount" resultType="int">
		SELECT COUNT(*)
		  FROM PRODUCT
		 WHERE USE_YN = TRUE
		<include refid="search" />
 	</select>
 	
	<select id="reqProductList" resultType="ProductVO">
		SELECT pd.*
		  FROM( SELECT @rownum:=@rownum+1 AS rn, p.*
				  FROM ( SELECT pp.*
						   FROM PRODUCT pp
						  WHERE USE_YN = TRUE
						    AND STATE_CD = '1'
						  <include refid="reqsearch" />
						) p, (SELECT @rownum:=0) tmp
			   ) pd
		   LIMIT #{startIndex},#{cntPerPage}
	</select>
	
	<select id="reqProductCount" resultType="int">
		SELECT COUNT(*)
		  FROM PRODUCT
		 WHERE USE_YN = TRUE
		   AND STATE_CD = '1'
		<include refid="reqsearch" />
 	</select>

	<select id="selectDetailProd" resultType="productVO">
		SELECT    prod.PRODUCT_CD, prod.PRODUCT_NM, prod.MEMBER_ID
                , prod.STATE_CD, prod.STATE_NM, prod.VIEWCNT
                , IFNULL(prod.CONTENT, '') as CONTENT
				, (SELECT COUNT(bid.PRODUCT_CD) FROM BIDINFO bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD) as BID_CNT
				, IFNULL((SELECT MAX(bid.MONEY_BID) FROM BIDINFO bid WHERE bid.PRODUCT_CD = prod.PRODUCT_CD), 0) as BID_MAX_MONEY
		   FROM PRODUCT prod
		  WHERE prod.USE_YN = TRUE
		    AND prod.PRODUCT_CD = #{product_cd}
	</select>
	
	<select id="selectDetailAuct" resultType="AuctionInfoVO">
		SELECT    auct.PRODUCT_CD
                , IFNULL(auct.AUCTDATE_UNIT, 0) as AUCTDATE_UNIT
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_START, '%Y-%m-%d %H:%s'), '') as ACUTDATE_START_STR
                , IFNULL(DATE_FORMAT(auct.ACUTDATE_END, '%Y-%m-%d %H:%s'), '') as ACUTDATE_END_STR
				, IFNULL(auct.MONEY_FIRST, 0) as MONEY_FIRST
                , IFNULL(auct.MONEY_UNIT, 0) as MONEY_UNIT
                , auct.BAYNOW_YN
                , IFNULL(auct.BAYNOW_MONEY, 0) as BAYNOW_MONEY
		   FROM AUCTIONINFO auct
		  WHERE auct.PRODUCT_CD = #{product_cd}
	</select>
	
	<select id="selectDetailDeli" resultType="DeliveryInfoVO">
		SELECT    deli.PRODUCT_CD
                , IFNULL(deli.DELI_DIV_CD, '') as DELI_DIV_CD
                , IFNULL(deli.DELI_DIV_NM, '') as DELI_DIV_NM
		   FROM DELIVERYINFO deli
		  WHERE deli.PRODUCT_CD = #{product_cd}
	</select>
	
	<select id="selectImageList" resultType="ProductImageVO">
		SELECT *
		  FROM PRODUCTIMG
		 WHERE PRODUCT_CD = #{product_cd}
	</select>
	
	<update id="updateProductState">
		UPDATE PRODUCT
		   SET  STATE_CD = #{state_cd}
		      , STATE_NM = #{state_nm}
		 WHERE PRODUCT_CD = #{product_cd}
	</update>
 	
 	<sql id="reqsearch">
		<if test="keyWord != null and keyWord != ''">
			AND PRODUCT_NM like CONCAT('%',#{keyWord},'%')
		</if>
	</sql>
 	
 	<sql id="search">
		<if test="keyWord != null and keyWord != ''">
			AND PRODUCT_NM like CONCAT('%',#{keyWord},'%')
		</if>
		<if test="searchType != null and searchType != ''">
			AND STATE_CD = #{searchType}
		</if>
	</sql>
</mapper>
